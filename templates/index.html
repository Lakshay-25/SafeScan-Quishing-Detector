<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeScan | AI Phishing Detector</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <div class="main-wrapper">
        <!-- Header Section -->
        <header class="app-header">
            <div class="logo">
                <i class="fa-solid fa-shield-halved"></i> SafeScan
            </div>
            <p class="subtitle">AI-Powered QR Code Security Analysis</p>
        </header>

        <!-- Main Card -->
        <div class="scanner-card">

            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('upload')">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Upload Image
                </button>
                <button class="tab-btn" onclick="switchTab('camera')">
                    <i class="fa-solid fa-camera"></i> Live Scan
                </button>
            </div>

            <!-- Content Area: Upload -->
            <div id="upload-section" class="tab-content active">
                <form id="uploadForm" action="/analyze" method="post" enctype="multipart/form-data">
                    <div class="upload-zone" id="drop-zone">
                        <div class="icon-container">
                            <i class="fa-solid fa-image"></i>
                        </div>
                        <h3>Drag & Drop QR Code</h3>
                        <p>or click to browse files</p>
                        <input type="file" name="file" id="fileInput" accept="image/*" hidden />
                    </div>
                    <div id="file-name-display" class="file-info">No file selected</div>
                    <button type="submit" class="action-btn">
                        Analyze File <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </form>
            </div>

            <!-- Content Area: Camera -->
            <div id="camera-section" class="tab-content">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="scan-overlay">
                        <div class="scan-line"></div>
                    </div>
                    <div class="video-placeholder">
                        <i class="fa-solid fa-video-slash"></i>
                        <p>Camera is currently off</p>
                    </div>
                </div>

                <div class="camera-controls">
                    <button id="startCamBtn" class="secondary-btn">
                        <i class="fa-solid fa-power-off"></i> Start Camera
                    </button>
                    <button id="snapBtn" class="action-btn" disabled>
                        <i class="fa-solid fa-expand"></i> Capture & Analyze
                    </button>
                </div>
            </div>

            <!-- Status Bar -->
            <div id="status-bar" class="status-bar">
                <i class="fa-solid fa-circle-info"></i>
                <span id="status-text">Ready to scan. Select a mode above.</span>
            </div>
        </div>

        <footer class="footer">
            <p>&copy; 2025 SafeScan Project. Powered by Python Flask & CNN.</p>
        </footer>
    </div>

    <script>
        // UI Logic for Tabs
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Add active class to selected
            if(tabName === 'upload') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('upload-section').classList.add('active');
                stopWebcam(); // Save resources
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('camera-section').classList.add('active');
            }
        }

        // UI Logic for File Upload
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('file-name-display');

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = fileInput.files[0].name;
                fileNameDisplay.style.color = '#2ecc71';
                dropZone.classList.add('has-file');
            }
        });

        // Webcam Logic (Adapted from your code)
        const video = document.getElementById('video');
        const snapBtn = document.getElementById('snapBtn');
        const startCamBtn = document.getElementById('startCamBtn');
        const statusText = document.getElementById('status-text');
        const statusBar = document.getElementById('status-bar');
        const videoPlaceholder = document.querySelector('.video-placeholder');

        function setStatus(msg, type='info') {
            statusText.innerText = msg;
            statusBar.className = 'status-bar ' + type;
            console.log(`[${type}] ${msg}`);
        }

        let stream = null;

        async function startWebcam() {
            setStatus('Requesting camera access...', 'loading');
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                });
                video.srcObject = stream;
                video.style.opacity = "1"; // Show video
                videoPlaceholder.style.display = 'none';
                snapBtn.disabled = false;
                startCamBtn.style.display = 'none'; // Hide start button once active
                setStatus('Camera active. Align QR code within frame.', 'success');
            } catch (err) {
                setStatus('Camera access denied: ' + err.message, 'error');
            }
        }

        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.opacity = "0";
                videoPlaceholder.style.display = 'flex';
                snapBtn.disabled = true;
                startCamBtn.style.display = 'inline-block';
                setStatus('Camera stopped.', 'info');
            }
        }

        startCamBtn.addEventListener('click', startWebcam);

        snapBtn.addEventListener('click', async () => {
            if (!video.srcObject) return;

            // Visual feedback
            snapBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...';

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            setStatus('Processing image with AI model...', 'loading');

            const formData = new FormData();
            formData.append('image_base64', dataURL);

            try {
                const res = await fetch('/analyze', { method: 'POST', body: formData });
                const html = await res.text();
                document.open();
                document.write(html);
                document.close();
            } catch (err) {
                setStatus('Server error: ' + err, 'error');
                snapBtn.innerHTML = '<i class="fa-solid fa-expand"></i> Capture & Analyze';
            }
        });
    </script>
</body>
</html>